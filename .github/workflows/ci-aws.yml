name: CI (AWS)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deployment target'
        required: true
        type: choice
        options:
          - both
          - gcp-only
          - aws-only
        default: 'both'

concurrency:
  group: terraform-aws-prod
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  ci-aws:
    # Skip if manually triggered with gcp-only
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.deploy_target != 'gcp-only'
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      SERVICE_NAME: mmm-app
      S3_BUCKET: mmm-app-output-aws
      ECR_WEB_REPO: mmm-app-web
      ECR_TRAINING_REPO: mmm-app-training
      ECR_TRAINING_BASE_REPO: mmm-app-training-base
      # TF_VAR_* for sensitive/default vars
      TF_VAR_sf_private_key: ${{ secrets.SF_PRIVATE_KEY }}
      TF_VAR_auth_client_id: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
      TF_VAR_auth_client_secret: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
      TF_VAR_auth_cookie_secret: ${{ secrets.STREAMLIT_COOKIE_SECRET }}
      TF_VAR_scheduler_job_name: robyn-queue-tick
      TF_VAR_queue_name: default

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Compute image tags and URLs
        shell: bash
        run: |
          echo "IMG_TAG=${{ github.sha }}" >> "$GITHUB_ENV"
          
          # ECR registry URL
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          echo "ECR_REGISTRY=$ECR_REGISTRY" >> "$GITHUB_ENV"

          # Web service image
          echo "WEB_IMAGE_URL=$ECR_REGISTRY/$ECR_WEB_REPO:${{ github.sha }}" >> "$GITHUB_ENV"
          echo "WEB_IMAGE_URL_LATEST=$ECR_REGISTRY/$ECR_WEB_REPO:latest" >> "$GITHUB_ENV"

          # Training job image
          echo "TRAINING_IMAGE_URL=$ECR_REGISTRY/$ECR_TRAINING_REPO:${{ github.sha }}" >> "$GITHUB_ENV"
          echo "TRAINING_IMAGE_URL_LATEST=$ECR_REGISTRY/$ECR_TRAINING_REPO:latest" >> "$GITHUB_ENV"

          # Training base image
          echo "TRAINING_BASE_IMAGE_URL=$ECR_REGISTRY/$ECR_TRAINING_BASE_REPO:latest" >> "$GITHUB_ENV"

      - name: Set up QEMU (multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push web service image
        id: build_web
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.web
          platforms: linux/amd64
          push: true
          build-args: |
            GIT_SHA=${{ github.sha }}
          tags: |
            ${{ env.WEB_IMAGE_URL }}
            ${{ env.WEB_IMAGE_URL_LATEST }}
          cache-from: type=gha,scope=mmm-web-aws-${{ github.ref_name }}
          cache-to: type=gha,mode=max,scope=mmm-web-aws-${{ github.ref_name }}

      - name: Build & Push training-base
        id: build_training_base
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.training-base
          platforms: linux/amd64
          push: true
          tags: ${{ env.TRAINING_BASE_IMAGE_URL }}
          cache-from: type=gha,scope=mmm-training-base-aws
          cache-to: type=gha,mode=max,scope=mmm-training-base-aws

      - name: Build & Push training job image
        id: build_training
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.training
          build-args: |
            BASE_REF=${{ env.TRAINING_BASE_IMAGE_URL }}
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.TRAINING_IMAGE_URL }}
            ${{ env.TRAINING_IMAGE_URL_LATEST }}
          cache-from: type=gha,scope=mmm-training-aws
          cache-to: type=gha,mode=max,scope=mmm-training-aws

      - name: Setup Python for tests
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install CI dependencies
        shell: bash
        run: |
          pip install -r requirements-ci.txt

      - name: Auto-format code
        shell: bash
        run: |
          echo "Automatically formatting code..."
          make format

      - name: Commit formatted files
        shell: bash
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --staged --quiet || git commit -m "Auto-format code with black and isort [skip ci]"
          git push || echo "No changes to push"

      - name: Run unit tests
        shell: bash
        run: |
          echo "Running unit tests for single job run functionality..."
          python3 -m unittest tests.test_single_job_config -v

      - name: Compute digest-pinned image refs
        shell: bash
        run: |
          echo "WEB_IMAGE_DIGEST=${{ steps.build_web.outputs.digest }}" >> "$GITHUB_ENV"
          echo "TRAINING_IMAGE_DIGEST=${{ steps.build_training.outputs.digest }}" >> "$GITHUB_ENV"

          echo "WEB_IMAGE_REF=${{ env.ECR_REGISTRY }}/${{ env.ECR_WEB_REPO }}@${{ steps.build_web.outputs.digest }}" >> "$GITHUB_ENV"
          echo "TRAINING_IMAGE_REF=${{ env.ECR_REGISTRY }}/${{ env.ECR_TRAINING_REPO }}@${{ steps.build_training.outputs.digest }}" >> "$GITHUB_ENV"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0
          terraform_wrapper: false

      - name: Terraform init / validate
        working-directory: infra/terraform-aws
        env:
          TF_IN_AUTOMATION: "true"
        run: |
          terraform init -input=false -reconfigure -backend-config="key=envs/prod/terraform.tfstate"
          terraform -version
          terraform workspace new prod || terraform workspace select prod

          # Verify we're in the correct workspace
          CURRENT_WORKSPACE=$(terraform workspace show)
          if [ "$CURRENT_WORKSPACE" != "prod" ]; then
            echo "ERROR: Expected to be in 'prod' workspace but currently in '$CURRENT_WORKSPACE'"
            exit 1
          fi
          echo "âœ“ Confirmed workspace: $CURRENT_WORKSPACE"

          terraform fmt -check
          terraform validate

      - name: Terraform plan
        working-directory: infra/terraform-aws
        env:
          TF_IN_AUTOMATION: "true"
          TF_VAR_aws_region: ${{ env.AWS_REGION }}
          TF_VAR_service_name: ${{ env.SERVICE_NAME }}
          TF_VAR_s3_bucket_name: ${{ env.S3_BUCKET }}
          TF_VAR_web_image: ${{ env.WEB_IMAGE_REF }}
          TF_VAR_training_image: ${{ env.TRAINING_IMAGE_REF }}
        run: |
          echo "Deploying images (digest pinned):"
          echo "  Web service: $WEB_IMAGE_REF"
          echo "  Training task: $TRAINING_IMAGE_REF"

          terraform plan -input=false -var-file="envs/prod.tfvars" -out=tfplan

      - name: Terraform apply
        working-directory: infra/terraform-aws
        env:
          TF_IN_AUTOMATION: "true"
          TF_VAR_aws_region: ${{ env.AWS_REGION }}
          TF_VAR_service_name: ${{ env.SERVICE_NAME }}
          TF_VAR_s3_bucket_name: ${{ env.S3_BUCKET }}
          TF_VAR_web_image: ${{ env.WEB_IMAGE_REF }}
          TF_VAR_training_image: ${{ env.TRAINING_IMAGE_REF }}
        run: terraform apply -input=false -auto-approve tfplan

      - name: Print deployment info
        working-directory: infra/terraform-aws
        run: |
          echo "AWS Deployment completed successfully!"
          echo ""
          echo "Web Service URL:"
          terraform output web_service_url
          echo ""
          echo "Training Task Family:"
          terraform output training_task_family
          echo ""
          echo "Architecture:"
          echo "  - Web Interface: ECS Fargate Service (2 vCPUs, 4GB)"
          echo "  - Training Tasks: ECS Fargate Tasks (up to 8 vCPUs, 32GB)"
          echo "  - Storage: S3 Bucket ($S3_BUCKET)"
