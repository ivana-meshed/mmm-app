name: Cost Optimization Automation

on:
  # Run weekly on Sundays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      run_cleanup:
        description: 'Run artifact registry cleanup'
        required: false
        default: 'true'
        type: boolean
      run_cost_analysis:
        description: 'Run training cost analysis'
        required: false
        default: 'true'
        type: boolean

permissions:
  id-token: write
  contents: read
  issues: write  # For creating issues with cost reports

jobs:
  cost_optimization:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: datawarehouse-422511
      PROJECT_NUMBER: "321233323695"
      REGION: europe-west1
      ARTIFACT_REPO: mmm-repo
      WIF_POOL: github-pool
      WIF_PROVIDER: github-oidc
      SA_EMAIL: github-deployer@datawarehouse-422511.iam.gserviceaccount.com

    steps:
      - uses: actions/checkout@v4

      - name: Auth to Google (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ env.WIF_POOL }}/providers/${{ env.WIF_PROVIDER }}
          service_account: ${{ env.SA_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Run Artifact Registry Cleanup
        if: ${{ github.event.inputs.run_cleanup != 'false' }}
        shell: bash
        run: |
          echo "Running Artifact Registry cleanup..."
          
          # Run cleanup script (keeps last 10 versions by default)
          DRY_RUN=false KEEP_LAST_N=10 ./scripts/cleanup_artifact_registry.sh
          
          echo "Cleanup completed!"

      - name: Run Training Cost Analysis
        if: ${{ github.event.inputs.run_cost_analysis != 'false' }}
        shell: bash
        run: |
          echo "Running training cost analysis..."
          
          # Install jq and bc for cost calculations
          sudo apt-get update && sudo apt-get install -y jq bc
          
          # Run cost analysis for last 30 days
          DAYS_BACK=30 ./scripts/get_training_costs.sh > cost_report.txt
          
          echo "Cost analysis completed!"
          cat cost_report.txt

      - name: Check Repository Size After Cleanup
        if: ${{ github.event.inputs.run_cleanup != 'false' }}
        shell: bash
        run: |
          echo "Checking repository size after cleanup..."
          gcloud artifacts repositories describe ${{ env.ARTIFACT_REPO }} \
            --location=${{ env.REGION }} \
            --format="table(name,sizeBytes)"

      - name: Upload Cost Report
        if: ${{ github.event.inputs.run_cost_analysis != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: cost-report-${{ github.run_number }}
          path: cost_report.txt
          retention-days: 90

      - name: Create Issue with Cost Summary
        if: ${{ github.event.inputs.run_cost_analysis != 'false' && always() }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let reportContent = 'Cost report generation in progress...';
            
            try {
              if (fs.existsSync('cost_report.txt')) {
                reportContent = fs.readFileSync('cost_report.txt', 'utf8');
              }
            } catch (error) {
              console.log('Could not read cost report:', error);
            }
            
            const title = `Monthly Training Cost Report - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Automated Training Cost Analysis
            
This is an automated report generated by the cost optimization workflow.

\`\`\`
${reportContent}
\`\`\`

### Actions Taken
- ✅ Artifact Registry cleanup (if enabled)
- ✅ Training cost analysis (last 30 days)

### Next Steps
- Review the cost trends
- Check if any optimization opportunities exist
- Update budget alerts if needed

---
*Generated automatically by [Cost Optimization Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            // Create an issue with the cost report
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['cost-optimization', 'automated']
            });
